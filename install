#!/usr/bin/env bash
#
# install nvim config
#

# get script directory (works even when called from different location)
script_dir=$(cd "$(dirname "$0")" && pwd) || exit

# symlink to ~/.config/nvim
mkdir -p ~/.config
if [[ -L ~/.config/nvim ]]; then
	rm ~/.config/nvim
elif [[ -d ~/.config/nvim ]]; then
	backup_name="nvim.bak.$(date +%Y%m%d%H%M%S)"
	echo "backing up existing ~/.config/nvim to ~/.config/$backup_name"
	mv ~/.config/nvim ~/.config/"$backup_name"
fi
ln -s "$script_dir" ~/.config/nvim
echo "symlinked $script_dir -> ~/.config/nvim"

# tree-sitter-cli (required for treesitter parsers)
if ! command -v tree-sitter &>/dev/null; then
	echo 'installing tree-sitter-cli'
	mkdir -p ~/.local/bin
	case "$(uname -s)-$(uname -m)" in
		Linux-x86_64)
			ts_file="tree-sitter-linux-x64.gz"
			;;
		Darwin-arm64)
			ts_file="tree-sitter-macos-arm64.gz"
			;;
		Darwin-x86_64)
			ts_file="tree-sitter-macos-x64.gz"
			;;
		*)
			echo 'unsupported platform for tree-sitter-cli, install manually'
			ts_file=""
			;;
	esac
	if [[ -n $ts_file ]]; then
		curl -sL "https://github.com/tree-sitter/tree-sitter/releases/latest/download/$ts_file" |
			gunzip > ~/.local/bin/tree-sitter
		chmod +x ~/.local/bin/tree-sitter
		echo 'installed tree-sitter-cli to ~/.local/bin'
	fi
fi

# install plugins
if command -v nvim &>/dev/null; then
	echo 'installing nvim plugins (this may take a moment)'
	nvim --headless -c "Lazy sync" -c "qa" 2>/dev/null || true
	echo 'done'
else
	echo 'nvim not found, install neovim 0.11+ first'
fi
